name: Rust

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # --------------------------------------------------------------------------
  # Rust build & test
  # --------------------------------------------------------------------------
  build-and-test:
    name: Rust build & test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: sudo apt-get install -y libgomp1 build-essential clang libstdc++-12-dev

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: "nightly"
        override: true

    - name: Verify Rust version
      run: rustc --version

    - name: Update dependencies
      run: cargo update

    - name: Build
      run: cargo build --verbose

    - name: Build with xgboost features
      run: cargo build --verbose --features xgboost

    - name: Run tests
      run: cargo test --verbose --workspace

    - name: Run tests with xgboost features
      run: cargo test --verbose --features xgboost

  # --------------------------------------------------------------------------
  # Python bindings test
  # --------------------------------------------------------------------------
  python-test:
    name: Python bindings test
    runs-on: ubuntu-latest
    needs: build-and-test

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: sudo apt-get install -y libgomp1 build-essential clang libstdc++-12-dev

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: "nightly"
        override: true

    - name: Install Python test dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install maturin pytest numpy

    - name: Build & install Python bindings
      working-directory: redeem-properties-py
      run: |
        source ../.venv/bin/activate
        maturin develop --release

    - name: Run Python tests
      run: |
        source .venv/bin/activate
        python -m pytest redeem-properties-py/tests/ -v
